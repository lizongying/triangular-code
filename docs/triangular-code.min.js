class TriangularCode{constructor(t,e="",s=3,r=200){this.container=t;this.scale=Math.sin(this.degreesToRadians(60));this._svgNamespace="http://www.w3.org/2000/svg";this.bits=s;this.text=e;this.updateSize(r)}updateSize(t){this.size=t;const e=this.container;let s=e.querySelector("svg");if(s){while(s.firstChild){s.removeChild(s.firstChild)}}else{s=document.createElementNS(this._svgNamespace,"svg");s.setAttribute("transform",`scale(1,${this.scale})`);e.appendChild(s)}s.setAttribute("width",`${t}`);s.setAttribute("height",`${t}`);s.setAttribute("viewBox",`0 0 ${t} ${t}`);this._svg=s;this.encode()}updateText(t){this.text=t;const e=this.container;let s=e.querySelector("svg");if(s){while(s.firstChild){s.removeChild(s.firstChild)}}else{s=document.createElementNS(this._svgNamespace,"svg");s.setAttribute("transform",`scale(1,${this.scale})`);e.appendChild(s)}this._svg=s;this.encode()}updateColor(t){this.bits=t;const e=this.container;let s=e.querySelector("svg");if(s){while(s.firstChild){s.removeChild(s.firstChild)}}else{s=document.createElementNS(this._svgNamespace,"svg");s.setAttribute("transform",`scale(1,${this.scale})`);e.appendChild(s)}this._svg=s;this.encode()}degreesToRadians(t){return t*(Math.PI/180)}stringToBits(t){const e=new TextEncoder;const s=e.encode(t);const r="01";const o=[0,1];switch(this.bits){case 3:{let t=r;for(const e of s){t+=e.toString(2).padStart(8,"0")}while(t.length%3!==0){t+="0"}const e=[];for(let s=0;s<t.length;s+=3){const r=t.slice(s,s+3);e.push(parseInt(r,2))}return e}case 2:{let t=r;for(const e of s){t+=e.toString(2).padStart(8,"0")}const e=[];for(let s=0;s<t.length;s+=2){const r=t.slice(s,s+2);e.push(parseInt(r,2))}return e}default:{return o.concat(Array.from(s).flatMap(t=>t.toString(2).padStart(8,"0").split("")).map(Number))}}}numberToBits(t){const e=numericToQrBits(t);const s="00";const r=[0,0];switch(this.bits){case 3:{let t=s;for(const s of e){t+=s}while(t.length%3!==0){t+="0"}const r=[];for(let e=0;e<t.length;e+=3){const s=t.slice(e,e+3);r.push(parseInt(s,2))}return r}case 2:{let t=s;for(const s of e){t+=s}const r=[];for(let e=0;e<t.length;e+=2){const s=t.slice(e,e+2);r.push(parseInt(s,2))}return r}default:{return r.concat(e.split("").map(Number))}}}defaultColor(){return 0}padDataToVersion(t,e){const s=table[e];if(!s)throw new Error(`Unsupported TC version: ${e}`);if(t.length>s){throw new Error(`Data length (${t.length}) exceeds capacity (${s}) for TC version ${e}`)}if(t.length<s){return t.concat(new Array(s-t.length).fill(this.defaultColor()))}return t}getRequiredVersion(t){for(const[e,s]of Object.entries(table)){const r=Number(e);if(t<=s){return{version:r,capacity:s}}}throw new Error(`Data length (${t}) exceeds the maximum supported TC capacity. `+`Maximum supported capacity: ${Math.max(...Object.values(table))}`)}encode(t=this.text){this.text=t;let e=[];if(/^\d+$/.test(t)){e=this.numberToBits(t)}else{e=this.stringToBits(t)}console.log("data",e);const{version:s,capacity:r}=this.getRequiredVersion(e.length);console.log(`version: ${s}, capacity: ${r}`);e=this.padDataToVersion(e,s);let o=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0];if(e.length>32){o.push(0)}o=o.concat(e);let i=[[0,0,0],[0,0,1,0,0],[0,0,1,1,1,0,0],[0,0,1,1,0,1,1,0,0],[0,0,1,1,1,1,1,1,1,0,0]];const n=[[0],[0,0,0]];let a=0;let l=0;for(;;l++){let t=[];t.push(0,0);let e=a+2*l+1;t.push(...o.slice(a,e));t.push(0,0);n.push(t);if(e>=o.length){break}let s=2*l+2;a=e;if(o.length-e<=s*5){for(let t=0;t<5;t++){let e=[];e.push(0,0);let r=a+s;e.push(...o.slice(a,r));e.push(...Array(s-e.length+2).fill(0));e.push(...i[t]);n.push(e);a=r}break}}n.push(Array(2*l+17).fill(0));let c=this.size/(l+9);n.forEach((t,e)=>{let s=this.size/2-e*c/2;let r=e*c;t.forEach((t,e)=>{let o;let i;let n;if(e%2===0){o=[s+e*c/2,r];i=[s+e*c/2-c/2,r+c];n=[s+(e*c/2+c/2),r+c]}else{o=[s+e*c/2,r+c];i=[s+e*c/2-c/2,r];n=[s+(e*c/2+c/2),r]}const a=document.createElementNS(this._svgNamespace,"polygon");a.setAttribute("points",`${o.join(",")} ${i.join(",")} ${n.join(",")}`);let l=colors2;switch(this.bits){case 3:{l=colors8;break}case 2:{l=colors4;break}default:{l=colors2}}a.setAttribute("fill",argbToHex(l[t]));this._svg.appendChild(a)})})}}const table={23:32,33:146,43:311,53:526,63:791,73:1106,83:1471,93:1886};const colors2=[16777215,0];const colors4=[16777215,255,65280,16711680];const colors8=[16777215,16711680,65280,255,16776960,65535,16711935,0];const argbToHex=t=>{const e=(t&16777215).toString(16).padStart(6,"0");return`#${e.toUpperCase()}`};const numericToQrBits=(t,e=10)=>{const s=t.length;const r=s.toString(2).padStart(e,"0");let o="";const i=[];for(let e=0;e<t.length;e+=3){i.push(t.slice(e,e+3))}i.forEach(t=>{const e=parseInt(t,10);let s;switch(t.length){case 3:s=e.toString(2).padStart(10,"0");break;case 2:s=e.toString(2).padStart(7,"0");break;case 1:s=e.toString(2).padStart(4,"0");break;default:throw new Error("分組異常，請檢查輸入")}o+=s});return r+o};