(function(){function e(e,t,n){let r=[];for(let i=0;i<n;i++){let n=[];for(let r=0;r<t;r++){let a=i*t+r;n.push(e[a])}r.push(n)}return r}function t(e){return e.map(e=>e.map(e=>e<128?1:0))}function n(e,t,n){let r=new Uint8Array(t*n);for(let t=0;t<e.length;t+=4){let n=e[t],i=e[t+1],a=e[t+2];r[t/4]=Math.round(.299*n+.587*i+.114*a)}return r}function r(e){let t=e.length,n=e[0].length,r=Array.from({length:t},()=>Array(n).fill(!1)),i=[],a=[[1,0],[-1,0],[0,1],[0,-1],[1,1],[-1,-1],[1,-1],[-1,1]];for(let o=0;o<t;o++)for(let s=0;s<n;s++)if(e[o][s]===1&&!r[o][s]){let c=[[s,o]],l=[[s,o]];for(r[o][s]=!0;c.length;){let[i,o]=c.pop();for(let[s,u]of a){let a=i+s,d=o+u;a>=0&&a<n&&d>=0&&d<t&&e[d][a]===1&&!r[d][a]&&(r[d][a]=!0,l.push([a,d]),c.push([a,d]))}}i.push(l)}return i}function i(e,t){let n=new Set(t.map(e=>e.join(`,`))),r=[[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1]],[i,a]=t[0],o=i,s=a,c=0,l=[{x:o,y:s}];for(let e=0;e<5e4;e++){let e=!1;for(let t=-1;t<=6;t++){let i=(c+t+8)%8,a=o+r[i][0],u=s+r[i][1];if(n.has(a+`,`+u)){l.push({x:a,y:u}),o=a,s=u,c=i,e=!0;break}}if(!e||o===i&&s===a&&l.length>5)break}return l}function a(e){let t=e.length,n=[];for(let r=0;r<t;r++){let i=e[(r-10+t)%t],a=e[r],c=e[(r+10)%t],l=[i.x-a.x,i.y-a.y],u=[c.x-a.x,c.y-a.y],d=o(l,u)/(s(l)*s(u)+1e-6),f=Math.acos(Math.max(-1,Math.min(1,d)));f<1.7&&f>.5&&n.push(a)}if(n.length<1)return null;let r=new c(20,3).fit(n),i={};for(let e=0;e<r.length;e++){let t=r[e];i[t]||(i[t]=[]),i[t].push(n[e])}let a=Object.values(i).filter(e=>e.length>=1);return a.length===3?a.map(e=>{let t=e.reduce((e,t)=>({x:e.x+t.x,y:e.y+t.y}),{x:0,y:0});return{x:t.x/e.length,y:t.y/e.length}}):null}function o(e,t){return e[0]*t[0]+e[1]*t[1]}function s(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1])}var c=class{constructor(e,t){this.eps=e,this.minSamples=t}euclideanDistance(e,t){return Math.sqrt((e.x-t.x)**2+(e.y-t.y)**2)}getNeighbors(e,t){let n=[];for(let r=0;r<t.length;r++)this.euclideanDistance(t[e],t[r])<=this.eps&&n.push(r);return n}fit(e){let t=Array(e.length).fill(-1),n=0;for(let r=0;r<e.length;r++){if(t[r]!==-1)continue;let i=this.getNeighbors(r,e);if(i.length<this.minSamples){t[r]=-1;continue}t[r]=n;let a=new Set(i);for(let r of a){if(t[r]===-1&&(t[r]=n),t[r]!==-1)continue;t[r]=n;let i=this.getNeighbors(r,e);i.length>=this.minSamples&&i.forEach(e=>a.add(e))}n++}return t}};function l(e){let t=[];for(let n=0;n<3;n++)for(let r=n+1;r<3;r++){let i=e[n].x-e[r].x,a=e[n].y-e[r].y;t.push(Math.sqrt(i*i+a*a))}return t.sort((e,t)=>e-t),t[2]/t[0]<1.15}function u(e,t,n){return{x:(e.x+t.x+n.x)/3,y:(e.y+t.y+n.y)/3}}function d(e,t){let n=e.x-t.x,r=e.y-t.y;return Math.sqrt(n*n+r*r)}function f(e,t){let n=u(t[0],t[1],t[2]),r=d(t[0],t[1]),i=r*Math.sqrt(3)*5/8,a=null;for(let r of t){let t=m(e,r,p(r,n,i));if(a===null)a=t;else if(t!==a){a=-1;break}}return{corners:t,center:n,side:r,type:a}}function p(e,t,n){let r=t.x-e.x,i=t.y-e.y,a=Math.hypot(r,i);if(a===0)throw Error(`A and D are the same point; cannot determine direction`);let o=r/a,s=i/a;return{x:e.x+o*n,y:e.y+s*n}}function m(e,t,n){let r=e.length,i=e[0].length,a=[0,0,0,0,0];for(let o=0;o<100;o++){let s=o/99,c=t.x+(n.x-t.x)*s,l=t.y+(n.y-t.y)*s,u=Math.round(c),d=Math.round(l);if(u<0||u>=i||d<0||d>=r)continue;let f=e[d][u],p=Math.min(Math.floor(o/20),4);a[p]+=f}function o(e){return e>12}function s(e){return e<8}return o(a[0])&&o(a[1])&&o(a[2])&&o(a[3])&&s(a[4])?0:o(a[0])&&o(a[1])&&s(a[2])&&o(a[3])&&s(a[4])?1:-1}function h(e,t,n,r){let{width:i,height:a,data:o}=e,s=new Uint8Array(o.length),c=Math.floor(t),l=c*2+1,u=Array(l*l),d=Array(256),f=2*r*r;for(let e=-c;e<=c;e++)for(let t=-c;t<=c;t++){let n=e*e+t*t;u[(e+c)*l+(t+c)]=Math.exp(-n/f)}let p=2*n*n;for(let e=0;e<256;e++)d[e]=Math.exp(-(e*e)/p);let m=Array(i).fill(0).map((e,t)=>Math.max(0,t-c)),h=Array(i).fill(0).map((e,t)=>Math.min(i-1,t+c)),g=Array(a).fill(0).map((e,t)=>Math.max(0,t-c)*i),_=Array(a).fill(0).map((e,t)=>Math.min(a-1,t+c)*i);for(let e=0;e<a;e++){let t=e*i;for(let n=0;n<i;n++){let r=t+n,a=o[r],f=0,p=0;for(let t=g[e];t<=_[e];t+=i)for(let r=m[n];r<=h[n];r++){let s=t+r,m=u[(Math.floor(t/i)-(e-c))*l+(r-(n-c))]*d[Math.abs(o[s]-a)];f+=o[s]*m,p+=m}s[r]=Math.round(f/p)}}return s}let g={0:[0,0],1:[0,1],2:[1,0],3:[1,1]},_={0:[0,0,0],1:[0,0,1],2:[0,1,0],3:[0,1,1],4:[1,0,0],5:[1,0,1],6:[1,1,0],7:[1,1,1]};function v(e,t=1){let n=[],r=0,i=0;switch(t){case 1:break;case 2:e=e.flatMap(e=>g[e]);break;case 3:e=e.flatMap(e=>_[e]);break;default:throw Error(`bits error`)}let a=e.shift()<<1|e.shift();console.log(`sign`,a);let o=``;switch(a){case 0:{let t=e.slice(0,10),n=0;for(let e of t)n=n<<1|e;let r=e.slice(10).join(``).slice(0),i=n,a=0;for(;i>0;){let e,t,n;i>=3?(e=10,n=3):i===2?(e=7,n=2):(e=4,n=1);let s=r.slice(a,a+e);if(s.length<e)throw Error(`位元串長度不足，無法解析完整數據`);t=parseInt(s,2).toString(),t=t.padStart(n,`0`),console.log(`groupNum`,t),o+=t,a+=e,i-=n}if(o.length!==n)throw Error(`還原的數字串長度與標註長度不匹配，位元串可能損壞`);break}case 1:for(let t of e)if(r=r<<1|t,i++,i===8){if(r===0)break;n.push(r),r=0,i=0}o=y(n);break;default:throw Error(`error sign ${a}`)}return o}function y(e){try{if(typeof TextDecoder<`u`){let t=new Uint8Array(e);return new TextDecoder(`utf-8`,{fatal:!0}).decode(t)}let t=``,n=0;for(;n<e.length;){let r=e[n],i=0;if(!(r&128))i=r,n+=1;else if((r&224)==192){if(n+1>=e.length)throw Error(`UTF-8 字节不完整`);i=(r&31)<<6|e[n+1]&63,n+=2}else if((r&240)==224){if(n+2>=e.length)throw Error(`UTF-8 字节不完整`);i=(r&15)<<12|(e[n+1]&63)<<6|e[n+2]&63,n+=3}else if((r&248)==240){if(n+3>=e.length)throw Error(`UTF-8 字节不完整`);i=(r&7)<<18|(e[n+1]&63)<<12|(e[n+2]&63)<<6|e[n+3]&63,n+=4}else throw Error(`无效的 UTF-8 字节：${r}`);t+=String.fromCharCode(i)}return t}catch(e){return console.error(`UTF-8 解码失败：`,e.message),``}}let b={5:23,10:33,15:43,20:53,25:63,30:73,35:83,40:93},x={23:5,33:10,43:15,53:20,63:25,73:30,83:35,93:40},S=[{name:`white`,index:0,rgb:[255,255,255],hex:16777215},{name:`red`,index:1,rgb:[255,0,0],hex:16711680},{name:`green`,index:2,rgb:[0,255,0],hex:65280},{name:`blue`,index:3,rgb:[0,0,255],hex:255},{name:`yellow`,index:4,rgb:[255,255,0],hex:16776960},{name:`cyan`,index:5,rgb:[0,255,255],hex:65535},{name:`magenta`,index:6,rgb:[255,0,255],hex:16711935},{name:`black`,index:7,rgb:[0,0,0],hex:0}],C=[{name:`white`,index:0,rgb:[255,255,255],hex:16777215},{name:`blue`,index:1,rgb:[0,0,255],hex:255},{name:`green`,index:2,rgb:[0,255,0],hex:65280},{name:`red`,index:3,rgb:[255,0,0],hex:16711680}],w=(e=23)=>{let t=[],n=5;for(;;n++)if(e>23){if(t.push(Array.from({length:2*n+1},(t,r)=>[x[e]+n-r,n-2,r&1])),n+2===x[e]){let e=2*n+2;t.push(...Array.from({length:5},(t,r)=>Array.from({length:e},(t,i)=>[e-i+r+1,n+r-1,i&1])));break}}else{t.push(...Array.from({length:4},(e,t)=>Array.from({length:8},(e,r)=>[10-r+t,n+t-2,r&1])));break}return t.flat()};var T=class{constructor(e,t,n){this.imgData=e,this.w=t,this.h=n,this.bits=3}getModuleValueByMedianFilter(e,t,n=5){let r=[],i=Math.floor(n/2);for(let n=-i;n<=i;n++)for(let a=-i;a<=i;a++){let i=e+a,o=t+n;if(i>=0&&o>=0&&i<this.w&&o<this.h)switch(this.bits){case 3:{let{r:e,g:t,b:n}=E(this.imgData,this.w,i,o),a=O([e,t,n],3);r.push(a);break}case 2:{let{r:e,g:t,b:n}=E(this.imgData,this.w,i,o),a=O([e,t,n],2);r.push(a);break}default:r.push(this.binaryMatrix[o][i])}}return r.sort((e,t)=>e-t),r[Math.floor(r.length/2)]}roundToNearest5(e){return Math.floor(e/5)*5}parse(){let o=this.w,s=this.h;this.grayData=n(this.imgData,o,s),this.blurredGray=h({data:this.grayData,width:o,height:s},5,30,15),this.binaryMatrix=t(e(this.blurredGray,o,s));let c=r(this.binaryMatrix),u=[],p=[];for(let e of c){let t=i(this.binaryMatrix,e);if(t.length<20)continue;let n=a(t);if(n===null||n.length!==3||!l(n))continue;let r=f(this.binaryMatrix,n);r.type===1&&(u=[r]),p.push(r)}if(u.length!==1)return console.log(`not find`),null;switch(u.unshift(p.find(e=>e.type===0&&(e.side/p[1].side<1.2||e.side/p[1].side>.8))),console.log(`vertices`,u),this.getModuleValueByMedianFilter(Math.round(u[0].center.x),Math.round(u[0].center.y))){case 1:this.bits=3;break;case 3:this.bits=2;break;default:this.bits=1}console.log(`bits`,this.bits);let{A:m,B:g,C:_}=this.classifyTrianglePoints(u[1].corners,u[0].center),y=this.buildLocalBasis(m,g,_),{A:S,B:C,C:T}=this.classifyTrianglePoints(u[0].corners,u[1].center),E=this.buildLocalBasis(S,T,C),D={origin:y.origin,ex:{x:(y.ex.x+E.ex.x)/2,y:(y.ex.y+E.ex.y)/2},ey:{x:(y.ey.x+E.ey.x)/2,y:(y.ey.y+E.ey.y)/2},scaleX:(y.scaleX+E.scaleX)/2,scaleY:(y.scaleY+E.scaleY)/2},O=(u[0].side+u[1].side)/8,k=d(u[1].center,u[0].center)/O;console.log(`this.roundToNearest5(x)`,d(u[1].center,u[0].center),O,this.roundToNearest5(k));let A=b[this.roundToNearest5(k)]??93;console.log(`version:`,A);let j=w(A),M=x[A],N=Math.abs(this.globalToLocal(u[1].center,D).v-this.globalToLocal(u[0].center,D).v)/M,P=Math.abs(this.globalToLocal(u[1].center,D).u-this.globalToLocal(u[0].center,D).u)/M,F=[],I=[];for(let e of j){let t=this.globalToLocal(u[1].center,D).u-P*e[0],n=this.globalToLocal(u[0].center,D).v-N*e[1];e[2]===1&&(n+=N/3);let r=this.localToGlobal({u:t,v:n},D);I.push(this.getModuleValueByMedianFilter(Math.round(r.x),Math.round(r.y),3)),F.push({x:r.x,y:r.y})}let L=v(I,this.bits);return{regions:c,contours:p,points:F,vertices:u,A1:m,B1:g,C1:_,A2:S,B2:C,C2:T,bits:I,content:L}}classifyTrianglePoints(e,t){let n=1/0,r=-1/0,i=null,a=null;for(let o of e){let e=d(o,t);e<n&&(n=e,i=o),e>r&&(r=e,a=o)}let o=e.find(e=>e!==i&&e!==a),s=a,c=i;if(!o||!s||!c)throw Error(`三角点分类失败`);return{A:o,B:s,C:c}}safeHypot(e,t){e=Math.abs(e),t=Math.abs(t);let n=Math.max(e,t),r=Math.min(e,t);if(n<1e-12)return 1e-12;let i=r/n;return n*Math.sqrt(1+i*i)}ensureUnitVector(e){let t=this.safeHypot(e.x,e.y);return Math.abs(t-1)>1e-6?{x:e.x/t,y:e.y/t}:e}orthogonalize(e,t){let n=e.x*t.x+e.y*t.y,r={x:t.x-n*e.x,y:t.y-n*e.y};return this.ensureUnitVector(r)}buildLocalBasis(e,t,n){let r={x:(e.x+t.x)/2,y:(e.y+t.y)/2},i=t.x-e.x,a=t.y-e.y,o=this.safeHypot(i,a);if(o<1e-6)throw Error(`顶点A和B不能重合`);let s=this.ensureUnitVector({x:i/o,y:a/o}),c=n.x-r.x,l=n.y-r.y,u=this.safeHypot(c,l);if(u<1e-6)throw Error(`C点不能与AB中点重合`);let d={x:c/u,y:l/u};return d=this.orthogonalize(s,d),{origin:r,ex:s,ey:d,scaleX:o,scaleY:u}}globalToLocal(e,t){let n=e.x-t.origin.x,r=e.y-t.origin.y,i=this.preciseAdd(n*t.ex.x,r*t.ex.y),a=this.preciseAdd(n*t.ey.x,r*t.ey.y);return{u:i,v:a,uNorm:i/t.scaleX,vNorm:a/t.scaleY}}localToGlobal(e,t){let n=e.u??e.uNorm*t.scaleX,r=e.v??e.vNorm*t.scaleY,i=this.preciseAdd(n*t.ex.x,r*t.ey.x),a=this.preciseAdd(n*t.ex.y,r*t.ey.y);return{x:this.preciseAdd(t.origin.x,i),y:this.preciseAdd(t.origin.y,a)}}preciseAdd(e,t){return Math.abs(e)<Math.abs(t)?e+t:t+e}};function E(e,t,n,r){let i=(r*t+n)*4;return{r:e[i],g:e[i+1],b:e[i+2],a:e[i+3]}}function D(e,t){return(e[0]-t[0])**2+(e[1]-t[1])**2+(e[2]-t[2])**2}function O(e,t){let n=1/0,r=null,i=S;switch(t){case 2:i=C;break}for(let t of i){let i=D(e,t.rgb);i<n&&(n=i,r=t.index)}return r}self.onmessage=e=>{let{imageData:t,width:n,height:r}=e.data;try{let e=new T(new Uint8ClampedArray(t),n,r).parse();if(console.log(`res`,e),self.postMessage({success:!0,text:`res.content`}),e===null){self.postMessage({success:!1,text:``});return}self.postMessage({success:!0,text:e.content})}catch(e){self.postMessage({success:!1,text:``,error:e.message})}}})();